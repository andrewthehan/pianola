(this.webpackJsonppianola=this.webpackJsonppianola||[]).push([[0],{50:function(e,t,n){},77:function(e,t,n){},79:function(e,t,n){"use strict";n.r(t);var a=n(2),c=n.n(a),i=n(39),s=n.n(i),o=(n(50),n(4)),r=n(44),l=n(43),u=n(40),d=n(45),m=n(42),j=(n(77),n(0)),b=n(23);const{Pitch:h}=b.theory,f=Object.freeze({RELEASE_SUSTAIN_PEDAL:0,PRESS_SUSTAIN_PEDAL:1,RELEASE_KEY:2,PRESS_KEY:3});function O(e){const t=function(e){if(null==e)return[];const t=e.tracks.map((e=>e.notes)).flat(),n=t.reduce(((e,t)=>{const n=t.time;return e[n]=e[n]||[],e[n].push(t),e}),{}),a=Object.keys(n).map((e=>({time:parseFloat(e),action:f.PRESS_KEY,notes:n[e].map((e=>{let{name:t,midi:n,velocity:a}=e;return{name:t,midi:n,velocity:a}}))}))),c=t.reduce(((e,t)=>{const n=t.time+t.duration;return e[n]=e[n]||[],e[n].push(t),e}),{}),i=Object.keys(c).map((e=>({time:parseFloat(e),action:f.RELEASE_KEY,notes:c[e].map((e=>{let{name:t,midi:n,velocity:a}=e;return{name:t,midi:n,velocity:a}}))})));return[...a,...i,...Array.from(e.tracks.map((e=>e.controlChanges)).map((e=>e[64])).filter((e=>null!=e)).flat()).map((e=>{let{time:t,value:n}=e;return{time:t,action:0===n?f.RELEASE_SUSTAIN_PEDAL:f.PRESS_SUSTAIN_PEDAL}}))].sort(((e,t)=>e.time!==t.time?e.time-t.time:e.action!==t.action?e.action-t.action:0))}(e);return{actions:t,pressedNotes:new Set,sustain:!1,index:0,startTime:Object(j.now)(),paused:!1}}var p=n(1);var x=function(){const[e,t]=Object(a.useState)(),[n,c]=Object(a.useState)(),[i,s]=Object(a.useState)(O(null)),[b,x]=Object(a.useState)(1),y=Object(a.useCallback)((t=>{e.keyDown({midi:t.getProgramNumber()})}),[e]),g=Object(a.useCallback)((t=>{e.keyUp({midi:t.getProgramNumber()})}),[e]),E=Object(a.useMemo)((()=>Object(a.lazy)((async()=>{if(null==e){const e=await async function(){const e=new d.a({maxPolyphony:1/0});return e.toDestination(),await e.load(),e}();t(e)}return{default:m.Piano}}))),[e]);return Object(a.useMemo)((()=>{null!=n&&s(O(n))}),[n]),Object(a.useEffect)((()=>{if(null!=e)return function(e,t,n,a,c,i){const{actions:s,pressedNotes:r,sustain:l,index:u,startTime:d,paused:m}=e;if(m)return;if(null==s)return;if(u<0||u>=s.length)return;const{time:b,action:h,notes:O}=s[u],p=setTimeout((()=>{let s=l;switch(h){case f.PRESS_KEY:O.forEach((e=>{let{name:n,midi:a,velocity:c}=e;r.add(n),t({name:n,midi:a,velocity:c})}));break;case f.RELEASE_KEY:O.forEach((e=>{let{name:t,midi:a,velocity:c}=e;r.delete(t),n({name:t,midi:a,velocity:c})}));break;case f.PRESS_SUSTAIN_PEDAL:s=!0,a();break;case f.RELEASE_SUSTAIN_PEDAL:s=!1,c();break;default:throw new Error("Unrecognized action: ".concat(h))}i(Object(o.a)(Object(o.a)({},e),{},{sustain:s,index:u+1}))}),1e3*(b-(Object(j.now)()-d)));return()=>clearTimeout(p)}(i,(t=>e.keyDown(Object(o.a)(Object(o.a)({},t),{},{velocity:t.velocity*b}))),(t=>e.keyUp(Object(o.a)(Object(o.a)({},t),{},{velocity:t.velocity*b}))),e.pedalDown.bind(e),e.pedalUp.bind(e),s)}),[e,i,b]),Object(p.jsx)("div",{className:"container flex-column align-center",children:Object(p.jsxs)(a.Suspense,{fallback:Object(p.jsx)("div",{children:"Loading..."}),children:[Object(p.jsxs)("header",{className:"header flex-column justify-center align-center",children:[Object(p.jsx)("h1",{children:"Pianola"}),Object(p.jsxs)("span",{children:[Object(p.jsx)("label",{children:"by "}),Object(p.jsx)("a",{href:"https://andrewhan.dev",target:"_blank",rel:"noopener noreferrer",children:"andrewhan"})]})]}),Object(p.jsxs)("section",{className:"flex-column justify-center align-center",children:[Object(p.jsx)("label",{children:"Upload MIDI file:"}),Object(p.jsx)("input",{className:"file-input",type:"file",accept:".mid",onChange:async function(e){const t=e.target.files[0];if(null==t)return;const n=new FileReader;n.onload=()=>c(new u.Midi(n.result)),n.readAsArrayBuffer(t)}})]}),function(){if(null!=n)return Object(p.jsxs)("section",{className:"flex-column justify-center align-stretch",children:[Object(p.jsx)("section",{className:"media-control flex-column justify-center align-stretch",children:Object(p.jsxs)("section",{className:"flex-row",children:[Object(p.jsx)("button",{className:"icon-button",onClick:function(){!function(e,t,n){const{actions:a,index:c}=e;n(Object(o.a)(Object(o.a)({},e),{},{startTime:Object(j.now)()-a[c].time-.1,paused:t}))}(i,!i.paused,s)},children:i.paused?Object(p.jsx)(l.FaPlay,{}):Object(p.jsx)(r.FaPause,{})}),Object(p.jsxs)("section",{className:"flex-column justify-stretch flex",children:[Object(p.jsxs)("label",{children:["Progress: ",i.index,"/",i.actions.length]}),Object(p.jsx)("input",{type:"range",className:"scrubber",value:i.index,min:0,max:i.actions.length-1,onChange:function(t){!function(e,t,n,a){const{pressedNotes:c,sustain:i}=e;c.forEach((e=>t({name:e,midi:h.fromString(e).get().getProgramNumber()}))),i&&n(),c.clear(),a(Object(o.a)(Object(o.a)({},e),{},{sustain:!1,index:-1,startTime:Object(j.now)()}))}(i,(t=>e.keyUp(Object(o.a)(Object(o.a)({},t),{},{velocity:t.velocity*b}))),e.pedalUp.bind(e),s);const n=parseInt(t.target.value);!function(e,t,n){const{actions:a}=e;n(Object(o.a)(Object(o.a)({},e),{},{startTime:Object(j.now)()-a[t].time-.1,index:t}))}(i,n,s)}})]})]})}),Object(p.jsxs)("section",{className:"media-control flex-column justify-center align-stretch",children:[Object(p.jsxs)("label",{children:["Volume: ",Math.round(100*b),"%"]}),Object(p.jsx)("input",{type:"range",className:"volume",value:b,min:0,max:1,step:"any",onChange:function(e){const t=parseFloat(e.target.value);x(t)}})]})]})}(),Object(p.jsxs)(a.Fragment,{children:[Object(p.jsx)(E,{className:"piano",start:"A0",end:"C8",onKeyPress:y,onKeyRelease:g,highlight:[...i.pressedNotes]}),Object(p.jsx)("div",{className:i.sustain?"pedal-down":"pedal-up",children:"Sustain pedal"})]})]})})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var y=e=>{e&&e instanceof Function&&n.e(3).then(n.bind(null,80)).then((t=>{let{getCLS:n,getFID:a,getFCP:c,getLCP:i,getTTFB:s}=t;n(e),a(e),c(e),i(e),s(e)}))};s.a.render(Object(p.jsx)(c.a.StrictMode,{children:Object(p.jsx)(x,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((e=>{e.unregister()})).catch((e=>{console.error(e.message)})),y()}},[[79,1,2]]]);
//# sourceMappingURL=main.339f253a.chunk.js.map